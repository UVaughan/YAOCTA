@page "/"
@inject IUriHelper UriHelper
<div class="jumbotron">
    <h1 class="display-4">Minimalist OC Transpo App</h1>
</div>
<div class="input-group mb-3">
    <input type="search" 
           class="form-control" 
           placeholder="Search..."
           aria-label="Search" 
           aria-describedby="basic-addon1" 
           bind-value-oninput="@searchTerm"
           onkeydown="@((Action<UIKeyboardEventArgs>) ((e) => SearchKeyDown(e)))" />
</div>
@if (stops != null)
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th scope="col">Stop #</th>
                <th scope="col">Description</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var key in display)
            {
                <tr>
                    <th scope="row">@key.ToString()</th>
                    <td><NavLink href="@String.Format("stops/{0}", key.ToString())">@stops[key]</NavLink></td>
                </tr>
            }
        </tbody>
    </table>
    @if(display.Count() < stops.Keys.Count())
    {
        <button type="button" class="btn btn-outline-dark" onclick="@((Action)(() => LoadMore()))">Load More</button>
    }
}

@code {
    public const int incrementNumber = 10;

    public IDictionary<int, string> stops;

    public IEnumerable<int> display;

    private string searchTerm { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var dict = new Dictionary<int, string>();
        var assembly = Assembly.GetExecutingAssembly();
        var resourceName = assembly.GetManifestResourceNames().Single(str => str.EndsWith("stops.txt"));

        using (var stream = assembly.GetManifestResourceStream(resourceName))
        using (var reader = new StreamReader(stream))
        {
            var result = reader.ReadToEnd();
            var lines = result.Split(
            new[] { "\r\n", "\r", "\n" },
            StringSplitOptions.None
            );
            lines = lines.Skip(1).ToArray();
            foreach (var line in lines)
            {
                if (line == "")
                {
                    continue;
                }
                var terms = line.Split(',');
                try
                {
                    var key = Int32.Parse(terms[1]);
                    var value = StringManipulation.FormatStopName(terms[2]);

                    if (dict.ContainsKey(key))
                    {
                        continue;
                    }
                    dict.Add(key, value);
                }
                catch (FormatException e)
                {
                    Console.WriteLine("Could not extract integer from " + terms[1]);
                }
            }
            stops = dict;
            display = dict.Keys.Take(incrementNumber);
        }
    }

    private void SearchKeyDown(UIKeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Console.WriteLine("FUUUUUUCK");
            this.StateHasChanged();
        }
    }

    private void LoadMore()
    {
        var incAmount = ((display.Count() + incrementNumber) > stops.Keys.Count()) ? (stops.Keys.Count() - display.Count()) : incrementNumber;
        display = stops.Keys.Take(display.Count() + incAmount);
    }
}
